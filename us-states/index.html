<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US States Explorer - Family Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #0f172a; overflow: hidden; font-family: sans-serif; }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #111827; }
        #map-svg { width: 100%; height: 100%; display: block; }
        .state-path { stroke: #94a3b8; stroke-width: 1.5px; cursor: pointer; transition: all 0.2s; fill: #374151; }
        .state-path:hover { fill: #4b5563 !important; stroke: white; stroke-width: 3px; }
        .hud { position: absolute; z-index: 10; pointer-events: none; }
        .hud-content { pointer-events: auto; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border: 2px solid #475569; border-radius: 1.5rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
        #tooltip { position: absolute; opacity: 0; pointer-events: none; background: #0f172a; color: white; padding: 8px 16px; border-radius: 8px; border: 2px solid #f59e0b; font-size: 18px; font-weight: 900; z-index: 100; box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); }
        .pulse-button { animation: pulse 2s infinite; cursor: pointer; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="start-screen" class="fixed inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center p-6 text-center">
            <h1 class="text-7xl font-black mb-6 text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-500 uppercase tracking-tighter">US EXPLORER</h1>
            <p id="loading-voice-text" class="text-2xl mb-10 text-amber-400 animate-pulse font-black">Warming up the explorer engines...</p>
            <button id="start-btn" class="hidden bg-orange-500 hover:bg-orange-600 text-white font-black py-6 px-16 rounded-full text-4xl shadow-2xl transition-all hover:scale-110">START ADVENTURE</button>
        </div>

        <div id="winner-screen" class="hidden fixed inset-0 z-50 bg-orange-900/98 flex flex-col items-center justify-center p-6 text-center">
            <div class="text-9xl mb-6">üèÅ</div>
            <h1 id="winner-text" class="text-8xl font-black mb-4 text-white uppercase"></h1>
            <p class="text-3xl mb-10 text-orange-100 font-bold">Papa Pooh is so proud of his champions!</p>
            <button onclick="location.reload()" class="bg-white text-orange-900 font-black py-4 px-12 rounded-full text-3xl shadow-2xl">PLAY AGAIN</button>
        </div>

        <div class="hud top-4 left-1/2 -translate-x-1/2">
            <a href="../" class="hud-content px-8 py-3 text-white hover:bg-slate-800 font-black text-lg uppercase tracking-widest border-orange-500/50 transition-colors">üè† Back to Lobby</a>
        </div>

        <div class="hud top-4 left-4">
            <div class="hud-content p-5 flex gap-10">
                <div id="box-Alani" class="text-center transition-all"><p class="text-xs font-black text-emerald-400 uppercase tracking-widest">ALANI üéæ</p><p id="score-Alani" class="text-5xl font-mono font-bold text-white">0</p></div>
                <div class="w-px bg-slate-700 h-16"></div>
                <div id="box-Wilder" class="text-center opacity-50 transition-all"><p class="text-xs font-black text-cyan-400 uppercase tracking-widest">WILDER üéÆ</p><p id="score-Wilder" class="text-5xl font-mono font-bold text-white">0</p></div>
            </div>
        </div>

        <div class="hud top-1/2 left-4 -translate-y-1/2">
            <button onclick="papaEncourage()" class="hud-content pulse-button p-5 flex flex-col items-center gap-3 border-orange-400 border-4 bg-slate-900 shadow-2xl">
                <span class="text-6xl">üë¥</span>
                <p class="text-orange-400 font-black text-sm uppercase tracking-widest">Ask Papa!</p>
            </button>
        </div>

        <div class="hud top-4 right-4 text-right">
            <div class="hud-content p-8 border-4 border-cyan-500/50 min-w-[350px]">
                <p id="turn-label" class="text-cyan-400 text-lg font-black uppercase mb-2"></p>
                <p class="text-slate-400 text-xs uppercase font-black">Find this state:</p>
                <h2 id="target-state" class="text-6xl font-black text-white leading-none tracking-tighter">---</h2>
                <p id="hint-text" class="text-amber-300 text-sm font-bold italic mt-6 hidden bg-amber-900/60 p-4 rounded-2xl border border-amber-500/50 shadow-lg">üí° Hint: Look for the orange highlights!</p>
            </div>
        </div>

        <div id="fact-container" class="hud bottom-10 left-10 opacity-0 transition-opacity duration-500 max-w-lg">
            <div class="hud-content border-orange-500/50 p-8">
                <div class="flex items-center gap-4 mb-3"><span class="text-3xl">ü¶æ</span><h4 class="text-orange-400 font-black text-sm uppercase tracking-widest">Family & State Facts</h4></div>
                <p id="fact-text" class="text-xl text-slate-100 leading-relaxed font-bold italic"></p>
            </div>
        </div>

        <svg id="map-svg"></svg>
        <div id="tooltip"></div>
    </div>

    <script>
        const players = ['Alani', 'Wilder'];
        let currentPlayer = 'Alani';
        let scores = { Alani: 0, Wilder: 0 };
        let targetState = null;
        let preferredVoice = null;

        const stateFacts = {
            "Florida": "Florida is your special home! It has the most golf courses in America. Papa Pooh is waiting for you there right now!",
            "California": "California has a forest of giant trees so big you can drive a car through them! High score for Wilder!",
            "Texas": "Texas is so big, Alani could hit a tennis ball across the state and it would take a year to land!",
            "New York": "New York City has more people than some entire countries! It's very loud and very busy!",
            "Hawaii": "Hawaii is the only state that is a group of islands. It even has its own special language!",
            "Alaska": "Alaska is the biggest state, and it has over 3,000 rivers! It's a giant playground for explorers!",
            "Georgia": "Georgia is where the world's first Coca-Cola was served! Sweet and bubbly!",
            "Arizona": "Arizona has a hole in the ground called the Grand Canyon that is 1 mile deep! Don't drop your video game, Wilder!",
            "Maine": "Maine is the only state whose name is just one syllable. Quick, say it! Maine!",
            "New Jersey": "New Jersey has the most diners in the whole world! Perfect for a huge family breakfast!"
        };

        const stateRegions = {
            "Florida": "the South", "Georgia": "the South", "Texas": "the South",
            "California": "the West", "Alaska": "the West", "Hawaii": "the West", "Arizona": "the West",
            "New York": "the East Coast", "Maine": "the East Coast", "New Jersey": "the East Coast"
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type, dur, vol) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        function initVoices() {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                preferredVoice = voices.find(v => v.name.includes('Female') || v.name.includes('Google US English') || v.name.includes('Samantha'));
                document.getElementById('loading-voice-text').innerText = "Alani and Wilder, get ready to travel across America!";
                document.getElementById('start-btn').classList.remove('hidden');
            }
        }
        window.speechSynthesis.onvoiceschanged = initVoices;
        initVoices();

        function speak(text, onEnd) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            if (preferredVoice) u.voice = preferredVoice;
            u.pitch = 1.2; u.rate = 0.95; u.onend = onEnd;
            window.speechSynthesis.speak(u);
        }

        function papaEncourage() {
            const lines = ["Don't give up! You're the best explorers in the USA!", "Papa Pooh says: Keep looking! You're almost there!", "Alani and Wilder, I believe in you! Try one more time!"];
            speak(lines[Math.floor(Math.random() * lines.length)]);
        }

        const svg = d3.select("#map-svg");
        const g = svg.append("g");
        
        // FIXED PROJECTION MATH
        const projection = d3.geoAlbersUsa().scale(1300).translate([window.innerWidth / 2, window.innerHeight / 2]);
        const path = d3.geoPath().projection(projection);

        svg.call(d3.zoom().scaleExtent([1, 12]).on("zoom", (e) => g.attr("transform", e.transform)));

        // Load TOPOLOGICAL map data (more stable for D3)
        d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then(us => {
            const states = topojson.feature(us, us.objects.states).features;
            g.selectAll("path").data(states).enter().append("path")
                .attr("d", path).attr("class", "state-path")
                .on("mouseover", function(event, d) {
                    d3.select("#tooltip").style("opacity", 1).html(d.properties.name).style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 20) + "px");
                    d3.select(this).style("stroke", "#fff").style("stroke-width", "4px");
                })
                .on("mouseout", function() {
                    d3.select("#tooltip").style("opacity", 0);
                    d3.select(this).style("stroke", "#94a3b8").style("stroke-width", "1.5px");
                })
                .on("click", (e, d) => handleStateClick(d.properties.name));
        });

        document.getElementById('start-btn').onclick = () => {
            audioCtx.resume();
            document.getElementById('start-screen').classList.add('hidden');
            speak("Ready to travel America? Alani, use your tennis eyes! Wilder, it's time to play! Alani, find the first state!", nextRound);
        };

        function nextRound() {
            if (scores.Alani >= 1000 || scores.Wilder >= 1000) { endGame(); return; }
            const list = Object.keys(stateRegions);
            targetState = list[Math.floor(Math.random() * list.length)];
            document.getElementById('target-state').innerText = targetState;
            document.getElementById('turn-label').innerText = currentPlayer + "'s Turn";
            document.getElementById('fact-container').style.opacity = "0";
            document.getElementById('box-Alani').style.opacity = (currentPlayer === 'Alani' ? "1" : "0.3");
            document.getElementById('box-Wilder').style.opacity = (currentPlayer === 'Wilder' ? "1" : "0.3");
            const h = document.getElementById('hint-text');
            if (currentPlayer === 'Wilder') { h.innerText = "üí° Hint: It's in " + stateRegions[targetState]; h.classList.remove('hidden'); }
            else { h.classList.add('hidden'); }
            g.selectAll("path").transition().duration(500).style("fill", d => {
                if (currentPlayer === 'Wilder' && stateRegions[d.properties.name] === stateRegions[targetState]) return "#f59e0b";
                return "#374151";
            });
        }

        function handleStateClick(name) {
            if (name === targetState) {
                playSound(880, 'sine', 0.2, 0.6);
                scores[currentPlayer] += 200;
                document.getElementById('score-' + currentPlayer).innerText = scores[currentPlayer];
                const fact = stateFacts[name] || "This state is full of incredible secrets waiting for you!";
                document.getElementById('fact-text').innerText = fact;
                document.getElementById('fact-container').style.opacity = "1";
                speak("Bingo! " + fact, () => { currentPlayer = currentPlayer === 'Alani' ? 'Wilder' : 'Alani'; speak("Now it is " + currentPlayer + "'s turn", nextRound); });
            } else {
                playSound(150, 'square', 0.3, 0.4);
                speak("Not that one! That was " + name + ". But Alani and Wilder never give up!", () => { currentPlayer = currentPlayer === 'Alani' ? 'Wilder' : 'Alani'; nextRound(); });
            }
        }

        function endGame() {
            const winner = scores.Alani >= 1000 ? 'Alani' : 'Wilder';
            document.getElementById('winner-text').innerText = winner + " Wins!";
            document.getElementById('winner-screen').classList.remove('hidden');
            speak("Hooray! Congratulations " + winner + "! You are the champion of the USA! Papa Pooh is so proud of you both!");
        }
    </script>
</body>
</html>
